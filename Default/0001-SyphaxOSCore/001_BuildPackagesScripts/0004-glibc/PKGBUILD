# Maintainer: Hatem Masmoudi <hatem.masmoudi@gmail.com>

pkgname=glibc
pkgver=2.25
pkgrel=4
pkgdesc="The Glibc package contains the main C library."
arch=('x86_64')
url="http://ftp.gnu.org/gnu/glibc"
license=('GPL')
groups=('core')
source=("$url/$pkgname-$pkgver.tar.xz")
md5sums=('1496c3bf41adf9db0ebd0af01f202eed')
depends=('rootfs>=2.0.0')

prepare() {
   cd "$srcdir/$pkgname-$pkgver"
   
   patch -Np1 -i ../../glibc-2.25-fhs-1.patch
   patch -Np1 -i ../../glibc.git-58520986c38e34db60e07260c64c563e3efcf353.patch
   patch -Np1 -i ../../glibc.git-045e368799cd253ddbf8bdec42ed92e8ebb3ce67.patch
   patch -Np1 -i ../../glibc.git-93cf93e06ce123439e41d3d62790601c313134cb.patch
   patch -Np1 -i ../../glibc.git-69e0a87cc4c570e3b7218392fc3e743b5bddcce2.patch
   patch -Np1 -i ../../glibc.git-8b3caa41b9cb82651e72a0c87aa56719c134000e.patch
   patch -Np1 -i ../../glibc.git-0889003c67f9c2f520a37281c4b5c3b8a9861f46.patch
   patch -Np1 -i ../../glibc.git-27ab0d9518746dfb59ed2ba59daefc981dc10e38.patch
   patch -Np1 -i ../../glibc.git-f035c8d055f25eaf6c93772f308afac10ce31ef2.patch
   patch -Np1 -i ../../glibc.git-74522eeeaa4a39809a28f44171e71d36a69edb58.patch
   patch -Np1 -i ../../glibc.git-df29db0bec24211cfc917db52024bf8deecac2c9.patch
   
   mkdir -v build
}

build() {
   cd "$srcdir/$pkgname-$pkgver"
   cd build
   
   unset LD_LIBRARY_PATH
   CC=gcc ../configure --prefix=/usr          \
                       --enable-kernel=2.6.32 \
                       --enable-obsolete-rpc  \
                       --enable-stack-protector=strong \
                       libc_cv_slibdir=/lib
   make
}

package() {
   cd "$srcdir/$pkgname-$pkgver"
   cd build

   mkdir -p $pkgdir/etc/
   mkdir -p $pkgdir/lib
   mkdir -p $pkgdir/usr/lib
   ln -snfv lib $pkgdir/lib64
   ln -snfv lib $pkgdir/usr/lib64

   touch $pkgdir/etc/ld.so.conf

   make DESTDIR=$pkgdir install

   cp -v ../nscd/nscd.conf $pkgdir/etc/nscd.conf
   mkdir -pv $pkgdir/var/cache/nscd

   install -v -Dm644 ../nscd/nscd.tmpfiles $pkgdir/usr/lib/tmpfiles.d/nscd.conf
   install -v -Dm644 ../nscd/nscd.service $pkgdir/lib/systemd/system/nscd.service

   mkdir -pv $pkgdir/usr/lib/locale
   localedef --prefix=$pkgdir -i en_GB -f UTF-8 en_GB.UTF-8
   localedef --prefix=$pkgdir -i en_US -f ISO-8859-1 en_US
   localedef --prefix=$pkgdir -i en_US -f UTF-8 en_US.UTF-8
   localedef --prefix=$pkgdir -i fr_FR -f ISO-8859-1 fr_FR
   localedef --prefix=$pkgdir -i fr_FR@euro -f ISO-8859-15 fr_FR@euro
   localedef --prefix=$pkgdir -i fr_FR -f UTF-8 fr_FR.UTF-8

   cp ../../../nsswitch.conf $pkgdir/etc/nsswitch.conf
   cp ../../../ld.so.conf $pkgdir/etc/ld.so.conf

   mkdir -pv $pkgdir/etc/ld.so.conf.d

   rm -rf $pkgdir/lib64
   rm -rf $pkgdir/usr/lib64
}
