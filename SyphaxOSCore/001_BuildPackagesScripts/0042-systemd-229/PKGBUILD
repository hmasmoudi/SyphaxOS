# Maintainer: Hatem Masmoudi <hatem.masmoudi@gmail.com>

pkgname=systemd
pkgver=229
pkgrel=1
pkgdesc="The systemd package contains programs for controlling the startup, running, and shutdown of the system."
arch=('x86_64')
install=$pkgname.install
url="http://anduin.linuxfromscratch.org/sources/other/systemd"
license=('GPL')
groups=('core')
source=("$url/$pkgname-$pkgver.tar.xz")
md5sums=('5d5115ee08affe005f821bc5ea3171e8')
depends=('rootfs>=1.0.0')

prepare() {
        cd "$srcdir/$pkgname-$pkgver"

        sed -i "s:blkid/::" $(grep -rl "blkid/blkid.h")
        patch -Np1 -i ../../systemd-229-compat-1.patch
        sed -e 's@test/udev-test.pl @@'  \
            -e 's@test-copy$(EXEEXT) @@' \
            -i Makefile.in

        autoreconf -fi
        cp -f ../../config.cache config.cache
}

build() {
        cd "$srcdir/$pkgname-$pkgver"

        ./configure --prefix=/usr    \
                    --disable-static \
                    --docdir=/usr/share/doc/gettext-0.19.7
        
        make LIBRARY_PATH=/lib
}

package() {
        cd "$srcdir/$pkgname-$pkgver"
        
        make LD_LIBRARY_PATH=/lib DESTDIR="$pkgdir" install

        mkdir -pv $pkgdir/lib
        mkdir -pv $pkgdir/sbin

        mv -v $pkgdir/usr/lib/libnss_{myhostname,mymachines,resolve}.so.2 $pkgdir/lib
        rm -rfv $pkgdir/usr/lib/rpm
        for tool in runlevel reboot shutdown poweroff halt telinit; do
             ln -sfv ../bin/systemctl $pkgdir/sbin/${tool}
        done
        ln -sfv ../lib/systemd/systemd $pkgdir/sbin/init
}
